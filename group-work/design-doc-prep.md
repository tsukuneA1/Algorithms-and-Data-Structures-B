# インデックス構築ツール (`prep`) I/O 解説

このツールは、検索対象のテキストデータを、コンピュータが高速に読み取れる「バイナリ形式の索引（インデックス）」に変換します。

## 1. 入力 (Input): `database.txt`

人間が読める形式のテキストファイルです。
各行に検索対象となる文字列が記述されています。行番号がそのまま「データID」として扱われます。

**ファイルイメージ:**

| 行番号 (ID) | データ内容 (15文字) | 備考 |
| --- | --- | --- |
| **ID: 0** | `AAAAAABDEDHAIAD` | 1行目のデータ |
| **ID: 1** | `AAAAAACHJACDCCJ` | 2行目のデータ |
| **ID: 2** | `AAAAACCECAGGBCE` | 3行目のデータ |
| ... | ... | ... |
| **ID: N** | `HGCCBBBCFFEHGGJ` | 最後のデータ |

---

## 2. 内部処理: メモリ上の状態 (Logical View)

プログラムはテキストを読み込むと、**「どの文字列(ID)に、どの特徴(3-gram)が含まれているか」** を管理する巨大な表（ビットマップ）をメモリ上に構築します。

これがソースコード上の `gram_bitsets` の正体です。

**論理的なデータの構造:**

* **行 (Row):** 3-gramの種類（ハッシュ値 000〜999）
* **列 (Col):** 文字列のID（0, 1, 2...）
* **値:** 含まれていれば `1` (True)、なければ `0` (False)

| Gram (Hash) | ID: 0 | ID: 1 | ID: 2 | ID: 3 | ID: 4 | ID: 5 | ... |
| --- | --- | --- | --- | --- | --- | --- | --- |
| **"AAA" (000)** | **1** | **1** | **1** | 0 | 0 | 1 | ... |
| **"ABC" (123)** | 0 | **1** | 0 | 0 | 0 | 0 | ... |
| **"CHH" (277)** | 0 | 0 | 0 | 0 | 0 | **1** | ... |
| ... | ... | ... | ... | ... | ... | ... | ... |

> **解説:**
> この表の「横一行」を見るだけで、例えば「"AAA"を含んでいるデータはどれか？」が一瞬で分かります。これを**転置インデックス**と呼びます。

---

## 3. バイナリ変換の仕組み (Compression)

上記の表をそのまま保存すると容量が大きくなるため、**「8列（8つのID）をまとめて 1バイト に圧縮」** してから書き出します。

**変換イメージ:**
例えば "AAA" の行にある `1, 1, 1, 0, 0, 1, 1, 0` という先頭8件のフラグは...

```text
[1] [1] [1] [0] [0] [1] [1] [0]  (8ビット分の情報)
 ↓   ↓   ↓   ↓   ↓   ↓   ↓   ↓
       1バイトの数値 (0xE6)

```

このように、100万件のID情報を `100万 ÷ 8 = 約125KB` のデータブロックに圧縮します。

---

## 4. 出力 (Output): `index.bin`

最終的に生成されるファイルは、以下の3つのパーツが連結されたバイナリファイルです。
テキストエディタでは文字化けして読めませんが、プログラムからは `mmap` を使って一瞬でメモリに展開できます。

**ファイル構造図:**

| 順番 | パーツ名 | サイズ | 役割と内容 |
| --- | --- | --- | --- |
| **1** | **ヘッダ** | 4 Byte | **データの総数 (N)**<br>

<br>例: `1,000,000` という数値（uint32）が埋め込まれています。 |
| **2** | **生データ** | 約 15 MB | **文字列の実体**<br>

<br>入力データの `A-J` を `0-9` の数値に変換してベタ書きしたもの。<br>

<br>※検索の最終工程で「本当に似ているか？」を確認するために使います。 |
| **3** | **索引データ** | 約 125 MB | **圧縮されたビットマップ (gram_bitsets)**<br>

<br>上記の「表」を上から順に、行ごとに圧縮バイナリ化して詰め込んだもの。<br>

<br>検索時はここだけを見て高速に候補を絞り込みます。 |